# Flaskのマイグレーション構造とinstanceディレクトリ

## 1. instanceディレクトリ

### 1.1 概要
- アプリケーション固有の設定やデータを格納するディレクトリ
- バージョン管理から除外される（`.gitignore`に記載）
- 機密情報や環境固有の設定を安全に管理できる

### 1.2 主な用途
- データベースファイル（`task_manager.db`）
- 環境固有の設定ファイル
- ログファイル
- 一時ファイル

### 1.3 特徴
- アプリケーションごとに独立した環境を提供
- 開発環境と本番環境で異なる設定を管理可能
- セキュリティ上重要な情報を安全に管理

## 2. migrationsディレクトリ

### 2.1 基本構造
```
migrations/
├── versions/          # マイグレーションファイルを格納
├── env.py            # マイグレーション環境の設定
├── script.py.mako    # マイグレーションファイルのテンプレート
├── README            # マイグレーションの説明
└── alembic.ini       # Alembicの設定ファイル
```

### 2.2 各ファイルの役割

#### 2.2.1 versions/
- 個々のマイグレーションファイルを格納
- ファイル名の形式：`<revision_id>_<description>.py`
- 例：`a1b2c3d4e5f6_initial_migration.py`

#### 2.2.2 env.py
- マイグレーション環境の設定
- データベース接続の設定
- マイグレーション実行時のフック
- モデルのインポートと設定

#### 2.2.3 script.py.mako
- 新しいマイグレーションファイルのテンプレート
- `upgrade()`と`downgrade()`関数の基本構造を提供
- マイグレーションの前後処理を記述

#### 2.2.4 README
- マイグレーションの基本的な説明
- 使用方法や注意事項

#### 2.2.5 alembic.ini
- Alembicの設定ファイル
- データベース接続情報
- ログ設定
- マイグレーションの動作設定

## 3. マイグレーションの基本コマンド

### 3.1 初期化
```bash
flask db init
```
- マイグレーション環境の初期化
- 必要なディレクトリとファイルの作成

### 3.2 マイグレーションの作成
```bash
flask db migrate -m "説明"
```
- モデルの変更を検出
- 新しいマイグレーションファイルを生成

### 3.3 マイグレーションの適用
```bash
flask db upgrade
```
- 保留中のマイグレーションを適用
- データベーススキーマを更新

### 3.4 マイグレーションのロールバック
```bash
flask db downgrade
```
- 直前のマイグレーションを元に戻す
- データベーススキーマを以前の状態に戻す

## 4. ベストプラクティス

### 4.1 マイグレーションファイルの管理
- 各マイグレーションは小さな変更に分割
- 明確な説明を付ける
- テスト環境で動作確認
- バージョン管理に含める

### 4.2 データベースの管理
- 本番環境のデータベースは定期的にバックアップ
- マイグレーション前にデータのバックアップを取得
- ロールバック手順を事前に確認

### 4.3 セキュリティ
- 機密情報は環境変数で管理
- 本番環境の接続情報は安全に管理
- アクセス権限を適切に設定 